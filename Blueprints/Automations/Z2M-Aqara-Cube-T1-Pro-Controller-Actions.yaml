blueprint:
  name: Aqara Cube T1 Pro - Action Mode ONLY (CTP-R01)
  author: SirGoodenough (Remixed by SpicyLimes)
  description: |
    ðŸ§Š Control your smart home with the Aqara Magic Cube T1 Pro via Zigbee2MQTT.
    
    ðŸŽ‰ **Features:**
    - 58+ unique commands (118+ total within modes)
    - Two operation modes: Action Mode and Scene Mode

    â­• **Action Groups:**
    - Group 1: Side-specific actions (36 action + 18 scene)
    - Group 2: Any-side actions (6 action + 3 scene)
    - Group 3: Side-to-side transitions (30 action + 30 scene)
    - Group 4: Mode-specific unique actions (5 total)

    â„¹ï¸ **Important Notes:**
    - MQTT topic must contain only alphanumeric characters (A-Z, a-z, 0-9)
    - Forward slashes (/) are allowed between device and topic
    - Ensure Z2M friendly_name matches HA entity name
    - No spaces or special characters except forward slash (/)
    - Example: `zigbee2mqtt/living_room_cube`

    âœðŸ» **Troubleshooting Template Error:**
     If you see "TemplateError: Must provide a device or entity ID":
     1. Open Zigbee2MQTT web UI
     2. Set the friendly_name to match your HA entity
     3. Enable "Update Home Assistant entity" option

    âš ï¸ **Warning:** 
     - Groups 1, 2, and 3 can trigger simultaneously. Choose one group per automation to avoid conflicts.
     - Group 4 Actions can be combined with any other group, however for simple actions, choose Group 2 and 4. If more actions/options are desired, use Groups 1 -OR- Group 3, and Group 4. 
    
    ðŸ“ [Documentation](https://github.com/SirGoodenough/HA_Blueprints/blob/master/Automations/Zigbee2MQTT%20-%20Xiaomi%20Cube%20Controller%20MQTT%20Triggered.md) | [Community Discussion](https://community.home-assistant.io/t/zigbee2mqtt-aqara-magic-cube-t1-pro-ctp-r01-xiaomi-lumi-cagl02/525111)

  source_url: https://github.com/SpicyLimes/Home-Assistant-Files/edit/main/Blueprints/Automations/Z2M-Aqara-Cube-T1-Pro-Controller.yaml
  domain: automation
  homeassistant:
    min_version: 2024.6.0

  input:
    # Required Configuration
    required_settings:
      name: "Required Settings"
      icon: mdi:cog-outline
      collapsed: false
      description: "Add your Device's MQTT Topic below - review important notes above for formatting information!"
      input:
        mqtt_topic:
          name: MQTT Topic
          description: The MQTT topic for your Device (e.g., zigbee2mqtt/cube_name)
          default: zigbee2mqtt/
          selector:
            text:
              multiline: false

    # Optional Conditions
    conditions:
      name: "ðŸ”§ Optional Conditions"
      icon: mdi:filter-variant
      collapsed: true
      description: Add time-based or state-based conditions to control when this automation runs
      input:
        extra_conditions:
          name: Additional Conditions
          description: Optional conditions (e.g., time of day, home occupancy)
          default: []
          selector:
            condition:

    # Action Mode - Group 1 (Side-Specific)
    action_g1_side1:
      name: "Action Mode - Side 1 (Aqara Logo) - Group 1 ðŸ”´"
      icon: mdi:numeric-1-box
      collapsed: true
      description: Side-specific actions for Face 1 (Aqara logo side)
      input:
        act_s1_slide:
          name: Slide (Face 1)
          default: []
          selector:
            action: {}
        act_s1_doubletap:
          name: Double Tap (Face 1)
          default: []
          selector:
            action: {}
        act_s1_flip90:
          name: Flip 90Â° to Face 1
          default: []
          selector:
            action: {}
        act_s1_flip180:
          name: Flip 180Â° to Face 1
          description: "âš ï¸ Advanced gesture - use sparingly"
          default: []
          selector:
            action: {}
        act_s1_flip_any:
          name: Flip from Any to Face 1
          default: []
          selector:
            action: {}
        act_s1_rotate_cw:
          name: Rotate Clockwise (Face 1)
          default: []
          selector:
            action: {}
        act_s1_rotate_ccw:
          name: Rotate Counter-Clockwise (Face 1)
          default: []
          selector:
            action: {}

    action_g1_side2:
      name: "Action Mode - Side 2 - Group 1 ðŸ”´"
      icon: mdi:numeric-2-box
      collapsed: true
      input:
        act_s2_slide:
          name: Slide (Face 2)
          default: []
          selector:
            action: {}
        act_s2_doubletap:
          name: Double Tap (Face 2)
          default: []
          selector:
            action: {}
        act_s2_flip90:
          name: Flip 90Â° to Face 2
          default: []
          selector:
            action: {}
        act_s2_flip180:
          name: Flip 180Â° to Face 2
          description: "âš ï¸ Advanced gesture - use sparingly"
          default: []
          selector:
            action: {}
        act_s2_flip_any:
          name: Flip from Any to Face 2
          default: []
          selector:
            action: {}
        act_s2_rotate_cw:
          name: Rotate Clockwise (Face 2)
          default: []
          selector:
            action: {}
        act_s2_rotate_ccw:
          name: Rotate Counter-Clockwise (Face 2)
          default: []
          selector:
            action: {}

    action_g1_side3:
      name: "Action Mode - Side 3 - Group 1 ðŸ”´"
      icon: mdi:numeric-3-box
      collapsed: true
      input:
        act_s3_slide:
          name: Slide (Face 3)
          default: []
          selector:
            action: {}
        act_s3_doubletap:
          name: Double Tap (Face 3)
          default: []
          selector:
            action: {}
        act_s3_flip90:
          name: Flip 90Â° to Face 3
          default: []
          selector:
            action: {}
        act_s3_flip180:
          name: Flip 180Â° to Face 3
          description: "âš ï¸ Advanced gesture - use sparingly"
          default: []
          selector:
            action: {}
        act_s3_flip_any:
          name: Flip from Any to Face 3
          default: []
          selector:
            action: {}
        act_s3_rotate_cw:
          name: Rotate Clockwise (Face 3)
          default: []
          selector:
            action: {}
        act_s3_rotate_ccw:
          name: Rotate Counter-Clockwise (Face 3)
          default: []
          selector:
            action: {}

    action_g1_side4:
      name: "Action Mode - Side 4 - Group 1 ðŸ”´"
      icon: mdi:numeric-4-box
      collapsed: true
      input:
        act_s4_slide:
          name: Slide (Face 4)
          default: []
          selector:
            action: {}
        act_s4_doubletap:
          name: Double Tap (Face 4)
          default: []
          selector:
            action: {}
        act_s4_flip90:
          name: Flip 90Â° to Face 4
          default: []
          selector:
            action: {}
        act_s4_flip180:
          name: Flip 180Â° to Face 4
          description: "âš ï¸ Advanced gesture - use sparingly"
          default: []
          selector:
            action: {}
        act_s4_flip_any:
          name: Flip from Any to Face 4
          default: []
          selector:
            action: {}
        act_s4_rotate_cw:
          name: Rotate Clockwise (Face 4)
          default: []
          selector:
            action: {}
        act_s4_rotate_ccw:
          name: Rotate Counter-Clockwise (Face 4)
          default: []
          selector:
            action: {}

    action_g1_side5:
      name: "Action Mode - Side 5 - Group 1 ðŸ”´"
      icon: mdi:numeric-5-box
      collapsed: true
      input:
        act_s5_slide:
          name: Slide (Face 5)
          default: []
          selector:
            action: {}
        act_s5_doubletap:
          name: Double Tap (Face 5)
          default: []
          selector:
            action: {}
        act_s5_flip90:
          name: Flip 90Â° to Face 5
          default: []
          selector:
            action: {}
        act_s5_flip180:
          name: Flip 180Â° to Face 5
          description: "âš ï¸ Advanced gesture - use sparingly"
          default: []
          selector:
            action: {}
        act_s5_flip_any:
          name: Flip from Any to Face 5
          default: []
          selector:
            action: {}
        act_s5_rotate_cw:
          name: Rotate Clockwise (Face 5)
          default: []
          selector:
            action: {}
        act_s5_rotate_ccw:
          name: Rotate Counter-Clockwise (Face 5)
          default: []
          selector:
            action: {}

    action_g1_side6:
      name: "Action Mode - Side 6 - Group 1 ðŸ”´"
      icon: mdi:numeric-6-box
      collapsed: true
      input:
        act_s6_slide:
          name: Slide (Face 6)
          default: []
          selector:
            action: {}
        act_s6_doubletap:
          name: Double Tap (Face 6)
          default: []
          selector:
            action: {}
        act_s6_flip90:
          name: Flip 90Â° to Face 6
          default: []
          selector:
            action: {}
        act_s6_flip180:
          name: Flip 180Â° to Face 6
          description: "âš ï¸ Advanced gesture - use sparingly"
          default: []
          selector:
            action: {}
        act_s6_flip_any:
          name: Flip from Any to Face 6
          default: []
          selector:
            action: {}
        act_s6_rotate_cw:
          name: Rotate Clockwise (Face 6)
          default: []
          selector:
            action: {}
        act_s6_rotate_ccw:
          name: Rotate Counter-Clockwise (Face 6)
          default: []
          selector:
            action: {}

    # Action Mode - Group 2 (Any Side)
    action_g2_any:
      name: "Action Mode - Any Side - Group 2 ðŸŸ "
      icon: mdi:cube-outline
      collapsed: true
      description: |
        âš ï¸ **Warning:** These actions also trigger Group 1 and Group 3 actions.
        Use only one group type per automation to avoid conflicts.
      input:
        act_any_slide:
          name: Slide (Any Side)
          default: []
          selector:
            action: {}
        act_any_doubletap:
          name: Double Tap (Any Side)
          default: []
          selector:
            action: {}
        act_any_flip90:
          name: Flip 90Â° (Any Side)
          default: []
          selector:
            action: {}
        act_any_flip180:
          name: Flip 180Â° (Any Side)
          description: "âš ï¸ Advanced gesture - use sparingly"
          default: []
          selector:
            action: {}
        act_any_rotate_cw:
          name: Rotate Clockwise (Any Side)
          default: []
          selector:
            action: {}
        act_any_rotate_ccw:
          name: Rotate Counter-Clockwise (Any Side)
          default: []
          selector:
            action: {}

    # Action Mode - Group 3 (Side Transitions)
    action_g3_to_side1:
      name: "Action Mode - Flip to Side 1 - Group 3 ðŸŸ¡"
      icon: mdi:numeric-1-circle
      collapsed: true
      description: |
        âš ï¸ **Warning:** Also triggers Group 1 flip actions and Group 2 any-side actions.
      input:
        act_1from2:
          name: Flip to Side 1 from Side 2
          default: []
          selector:
            action: {}
        act_1from3:
          name: Flip to Side 1 from Side 3
          default: []
          selector:
            action: {}
        act_1from4:
          name: Flip to Side 1 from Side 4
          default: []
          selector:
            action: {}
        act_1from5:
          name: Flip to Side 1 from Side 5
          default: []
          selector:
            action: {}
        act_1from6:
          name: Flip to Side 1 from Side 6
          default: []
          selector:
            action: {}

    action_g3_to_side2:
      name: "Action Mode - Flip to Side 2 - Group 3 ðŸŸ¡"
      icon: mdi:numeric-2-circle
      collapsed: true
      input:
        act_2from1:
          name: Flip to Side 2 from Side 1
          default: []
          selector:
            action: {}
        act_2from3:
          name: Flip to Side 2 from Side 3
          default: []
          selector:
            action: {}
        act_2from4:
          name: Flip to Side 2 from Side 4
          default: []
          selector:
            action: {}
        act_2from5:
          name: Flip to Side 2 from Side 5
          default: []
          selector:
            action: {}
        act_2from6:
          name: Flip to Side 2 from Side 6
          default: []
          selector:
            action: {}

    action_g3_to_side3:
      name: "Action Mode - Flip to Side 3 - Group 3 ðŸŸ¡"
      icon: mdi:numeric-3-circle
      collapsed: true
      input:
        act_3from1:
          name: Flip to Side 3 from Side 1
          default: []
          selector:
            action: {}
        act_3from2:
          name: Flip to Side 3 from Side 2
          default: []
          selector:
            action: {}
        act_3from4:
          name: Flip to Side 3 from Side 4
          default: []
          selector:
            action: {}
        act_3from5:
          name: Flip to Side 3 from Side 5
          default: []
          selector:
            action: {}
        act_3from6:
          name: Flip to Side 3 from Side 6
          default: []
          selector:
            action: {}

    action_g3_to_side4:
      name: "Action Mode - Flip to Side 4 - Group 3 ðŸŸ¡"
      icon: mdi:numeric-4-circle
      collapsed: true
      input:
        act_4from1:
          name: Flip to Side 4 from Side 1
          default: []
          selector:
            action: {}
        act_4from2:
          name: Flip to Side 4 from Side 2
          default: []
          selector:
            action: {}
        act_4from3:
          name: Flip to Side 4 from Side 3
          default: []
          selector:
            action: {}
        act_4from5:
          name: Flip to Side 4 from Side 5
          default: []
          selector:
            action: {}
        act_4from6:
          name: Flip to Side 4 from Side 6
          default: []
          selector:
            action: {}

    action_g3_to_side5:
      name: "Action Mode - Flip to Side 5 - Group 3 ðŸŸ¡"
      icon: mdi:numeric-5-circle
      collapsed: true
      input:
        act_5from1:
          name: Flip to Side 5 from Side 1
          default: []
          selector:
            action: {}
        act_5from2:
          name: Flip to Side 5 from Side 2
          default: []
          selector:
            action: {}
        act_5from3:
          name: Flip to Side 5 from Side 3
          default: []
          selector:
            action: {}
        act_5from4:
          name: Flip to Side 5 from Side 4
          default: []
          selector:
            action: {}
        act_5from6:
          name: Flip to Side 5 from Side 6
          default: []
          selector:
            action: {}

    action_g3_to_side6:
      name: "Action Mode - Flip to Side 6 - Group 3 ðŸŸ¡"
      icon: mdi:numeric-6-circle
      collapsed: true
      input:
        act_6from1:
          name: Flip to Side 6 from Side 1
          default: []
          selector:
            action: {}
        act_6from2:
          name: Flip to Side 6 from Side 2
          default: []
          selector:
            action: {}
        act_6from3:
          name: Flip to Side 6 from Side 3
          default: []
          selector:
            action: {}
        act_6from4:
          name: Flip to Side 6 from Side 4
          default: []
          selector:
            action: {}
        act_6from5:
          name: Flip to Side 6 from Side 5
          default: []
          selector:
            action: {}

    # Action Mode - Group 4 (Unique Actions)
    action_g4_unique:
      name: "Action Mode - Unique Actions - Group 4 ðŸŸ¢"
      icon: mdi:gesture
      collapsed: true
      description: These actions can be safely combined with any other group
      input:
        act_shake:
          name: Shake Cube
          default: []
          selector:
            action: {}
        act_throw:
          name: Throw Gesture
          description: |
            Pick up cube â†’ make throwing motion forward â†’ hold â†’ trigger fires
            (Don't actually throw the cube!)
          default: []
          selector:
            action: {}

# Trigger
trigger:
  - platform: mqtt
    topic: !input mqtt_topic

# Variables
variables:
  # Parse trigger payload
  action: >-
    {{ trigger.payload_json.action | default('none') }}
  angle: >-
    {{ trigger.payload_json.action_angle | float(0.0) }}
  side: >-
    {{ trigger.payload_json.side | int(0) }}
  op_mode: >-
    {{ trigger.payload_json.operation_mode | default('none') }}
  
  # Extract device identifiers
  topic_var: !input mqtt_topic
  friendly_name: >-
    {{ topic_var.split('/')[1] | regex_replace('[^A-Za-z0-9_/./-]', '') }}
  device_id: >-
    {{ device_id(friendly_name) }}
  ieee_id: >-
    {{ (device_attr(device_id, 'identifiers') | list)[0][1].split('_')[1] }}
  
  # Number helper entity for last_side tracking
  num_entity_id: >-
    {{ 'number.' ~ friendly_name ~ '_last_side' }}
  last_side: >-
    {% set val = states(num_entity_id) | default(0) %}
    {% if val not in ['undefined', 'unknown', 'unavailable', 'none', 'null', ''] %}
      {{ val | int(0) }}
    {% else %}
      0
    {% endif %}
  
  # MQTT configuration topics
  config_topic: >-
    homeassistant/number/{{ ieee_id }}/last_side/config
  state_topic: >-
    homeassistant/number/{{ ieee_id }}/last_side

# Conditions
condition:
  - condition: or
    conditions:
      - condition: template
        alias: Valid Action Mode trigger
        value_template: >-
          {{ trigger.payload_json is defined
             and trigger.payload_json.operation_mode == 'action_mode'
             and trigger.payload_json.action in 
                 ['rotate_right', 'rotate_left', 'flip90', 'flip180', 
                  'slide', 'tap', 'shake', 'throw'] }}
  - condition: !input extra_conditions

# Actions
action:
  # Create/update number helper via MQTT discovery
  - alias: Configure last_side number helper
    service: mqtt.publish
    data:
      topic: "{{ config_topic }}"
      retain: true
      payload: >-
        {
          "name": "last side",
          "avty_t": "homeassistant/status",
          "uniq_id": "{{ friendly_name }}-{{ device_id }}",
          "cmd_t": "{{ state_topic }}",
          "sta_t": "{{ state_topic }}",
          "min": 0,
          "max": 6,
          "step": 1,
          "mode": "box",
          "ret": true,
          "dev": {
            "name": "{{ friendly_name }}",
            "mdl": "Aqara Magic Cube T1 Pro Controller",
            "mf": "SirGoodenough",
            "sw": "2024-06-04",
            "hw": "https://github.com/SirGoodenough/HA_Blueprints",
            "ids": ["{{ ieee_id }}-last_side"]
          }
        }

  # Fire diagnostic event
  - alias: Publish cube action event
    event: cube_last_action
    event_data:
      action: "{{ action }}"
      side: "{{ side }}"
      last_side: "{{ last_side }}"
      friendly_name: "{{ friendly_name }}"
      device_id: "{{ device_id }}"
      ieee_id: "{{ ieee_id }}"
      angle: "{{ angle }}"
      mode: "{{ op_mode }}"

  # Update last_side state
  - alias: Store current side as last_side
    service: number.set_value
    target:
      entity_id: "{{ num_entity_id }}"
    data:
      value: "{{ side }}"

  # Mode-specific action handlers
  - alias: Route to mode handler
    choose:
      # === ACTION MODE ===
      - conditions: "{{ op_mode == 'action_mode' }}"
        sequence:
          # Group 2 & 4: Any-side and unique actions
          - alias: Handle any-side and unique actions
            choose:
              - conditions: "{{ action == 'slide' }}"
                sequence: !input act_any_slide
              - conditions: "{{ action == 'tap' }}"
                sequence: !input act_any_doubletap
              - conditions: "{{ action == 'rotate_right' }}"
                sequence: !input act_any_rotate_cw
              - conditions: "{{ action == 'rotate_left' }}"
                sequence: !input act_any_rotate_ccw
              - conditions: "{{ action == 'shake' }}"
                sequence: !input act_shake
              - conditions: "{{ action == 'throw' }}"
                sequence: !input act_throw
              - conditions: "{{ action == 'flip90' }}"
                sequence:
                  - parallel:
                      - !input act_any_flip90
                      - choose:
                          - conditions: "{{ side == 1 }}"
                            sequence: !input act_s1_flip_any
                          - conditions: "{{ side == 2 }}"
                            sequence: !input act_s2_flip_any
                          - conditions: "{{ side == 3 }}"
                            sequence: !input act_s3_flip_any
                          - conditions: "{{ side == 4 }}"
                            sequence: !input act_s4_flip_any
                          - conditions: "{{ side == 5 }}"
                            sequence: !input act_s5_flip_any
                          - conditions: "{{ side == 6 }}"
                            sequence: !input act_s6_flip_any
              - conditions: "{{ action == 'flip180' }}"
                sequence:
                  - parallel:
                      - !input act_any_flip180
                      - choose:
                          - conditions: "{{ side == 1 }}"
                            sequence: !input act_s1_flip_any
                          - conditions: "{{ side == 2 }}"
                            sequence: !input act_s2_flip_any
                          - conditions: "{{ side == 3 }}"
                            sequence: !input act_s3_flip_any
                          - conditions: "{{ side == 4 }}"
                            sequence: !input act_s4_flip_any
                          - conditions: "{{ side == 5 }}"
                            sequence: !input act_s5_flip_any
                          - conditions: "{{ side == 6 }}"
                            sequence: !input act_s6_flip_any

          # Group 1: Side-specific actions
          - alias: Handle side-specific actions
            choose:
              - conditions: "{{ action == 'slide' }}"
                sequence:
                  - choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input act_s1_slide
                      - conditions: "{{ side == 2 }}"
                        sequence: !input act_s2_slide
                      - conditions: "{{ side == 3 }}"
                        sequence: !input act_s3_slide
                      - conditions: "{{ side == 4 }}"
                        sequence: !input act_s4_slide
                      - conditions: "{{ side == 5 }}"
                        sequence: !input act_s5_slide
                      - conditions: "{{ side == 6 }}"
                        sequence: !input act_s6_slide
              - conditions: "{{ action == 'tap' }}"
                sequence:
                  - choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input act_s1_doubletap
                      - conditions: "{{ side == 2 }}"
                        sequence: !input act_s2_doubletap
                      - conditions: "{{ side == 3 }}"
                        sequence: !input act_s3_doubletap
                      - conditions: "{{ side == 4 }}"
                        sequence: !input act_s4_doubletap
                      - conditions: "{{ side == 5 }}"
                        sequence: !input act_s5_doubletap
                      - conditions: "{{ side == 6 }}"
                        sequence: !input act_s6_doubletap
              - conditions: "{{ action == 'flip90' }}"
                sequence:
                  - choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input act_s1_flip90
                      - conditions: "{{ side == 2 }}"
                        sequence: !input act_s2_flip90
                      - conditions: "{{ side == 3 }}"
                        sequence: !input act_s3_flip90
                      - conditions: "{{ side == 4 }}"
                        sequence: !input act_s4_flip90
                      - conditions: "{{ side == 5 }}"
                        sequence: !input act_s5_flip90
                      - conditions: "{{ side == 6 }}"
                        sequence: !input act_s6_flip90
              - conditions: "{{ action == 'flip180' }}"
                sequence:
                  - choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input act_s1_flip180
                      - conditions: "{{ side == 2 }}"
                        sequence: !input act_s2_flip180
                      - conditions: "{{ side == 3 }}"
                        sequence: !input act_s3_flip180
                      - conditions: "{{ side == 4 }}"
                        sequence: !input act_s4_flip180
                      - conditions: "{{ side == 5 }}"
                        sequence: !input act_s5_flip180
                      - conditions: "{{ side == 6 }}"
                        sequence: !input act_s6_flip180
              - conditions: "{{ action == 'rotate_right' }}"
                sequence:
                  - choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input act_s1_rotate_cw
                      - conditions: "{{ side == 2 }}"
                        sequence: !input act_s2_rotate_cw
                      - conditions: "{{ side == 3 }}"
                        sequence: !input act_s3_rotate_cw
                      - conditions: "{{ side == 4 }}"
                        sequence: !input act_s4_rotate_cw
                      - conditions: "{{ side == 5 }}"
                        sequence: !input act_s5_rotate_cw
                      - conditions: "{{ side == 6 }}"
                        sequence: !input act_s6_rotate_cw
              - conditions: "{{ action == 'rotate_left' }}"
                sequence:
                  - choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input act_s1_rotate_ccw
                      - conditions: "{{ side == 2 }}"
                        sequence: !input act_s2_rotate_ccw
                      - conditions: "{{ side == 3 }}"
                        sequence: !input act_s3_rotate_ccw
                      - conditions: "{{ side == 4 }}"
                        sequence: !input act_s4_rotate_ccw
                      - conditions: "{{ side == 5 }}"
                        sequence: !input act_s5_rotate_ccw
                      - conditions: "{{ side == 6 }}"
                        sequence: !input act_s6_rotate_ccw

          # Group 3: Side-to-side transitions
          - alias: Handle side transition actions
            choose:
              - conditions: "{{ side == 1 }}"
                sequence:
                  - choose:
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input act_1from2
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input act_1from3
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input act_1from4
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input act_1from5
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input act_1from6
              - conditions: "{{ side == 2 }}"
                sequence:
                  - choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input act_2from1
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input act_2from3
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input act_2from4
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input act_2from5
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input act_2from6
              - conditions: "{{ side == 3 }}"
                sequence:
                  - choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input act_3from1
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input act_3from2
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input act_3from4
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input act_3from5
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input act_3from6
              - conditions: "{{ side == 4 }}"
                sequence:
                  - choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input act_4from1
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input act_4from2
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input act_4from3
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input act_4from5
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input act_4from6
              - conditions: "{{ side == 5 }}"
                sequence:
                  - choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input act_5from1
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input act_5from2
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input act_5from3
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input act_5from4
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input act_5from6
              - conditions: "{{ side == 6 }}"
                sequence:
                  - choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input act_6from1
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input act_6from2
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input act_6from3
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input act_6from4
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input act_6from5

  # Debounce delay for toggle functions
  - alias: Debounce delay
    delay: "00:00:01"

mode: single
max_exceeded: silent
