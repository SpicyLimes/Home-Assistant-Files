blueprint:
  name: "Aqara Cube T1 Pro via ZHA (Remix)"
  author: "SpicyLimes"
  description: >

    Automate actions for the Aqara Cube T1 Pro using ZHA. Assign scripts to specific cube actions (slide, double-tap, rotate, flip, shake). Actions are grouped by specific side, any side, or flips between sides. Most actions can trigger multiple groups at once; assign actions in only one group to avoid double triggers. "Drop" is not supported on the Cube T1 Pro.


    For troubleshooting, a diagnostic event is fired with the last action. To show the last action, create a template sensor for the "zha_cube_last_action" event.


    Original Blueprint by: [SirGoodenough](https://community.home-assistant.io/t/zha-xiaomi-cube-controller/495975)
  source_url: https://github.com/SpicyLimes/Home-Assistant-Files/blob/main/Blueprints/Automations/Aqara-Cube.yaml
  domain: automation
  input:
    required_input:
      name: "Required input"
      description: >
        Select the Aqara Cube (ZHA device) and a Numeric Helper to track the last side up. The helper must be an input_number entity with min=0, max=5, step=1.
      input:
        last_side_input:
          name: Last side numeric helper
          description: Select an input_number helper (min=0, max=5, step=1) to track last side.
          selector:
            entity:
              filter:
              - domain: 
                - input_number
              multiple: false
        cube:
          name: Aqara Cube
          description: Select your Aqara Cube device (ZHA, manufacturer=LUMI).
          selector:
            device:
              filter:
              - integration: zha
                manufacturer: LUMI
              multiple: false
    optional_conditions:
      name: "Optional conditions"
      description: >
        Add conditions to limit when this automation runs (e.g. only when home, only during certain times).
      input:
        additional_conditions:
          name: Additional conditions
          description: "Extra conditions for this automation."
          default: []
          selector:
            condition: {}
    side_0_group_1_actions:
      name: "Face 0 Group 1 Actions"
      description: "Actions for Face 0 up (Aqara logo)."
      input:
        slide_face_0:
          name: "Slide (Face 0 Up)"
          description: "Face 0 up."
          default: []
          selector:
            action: {}
        doubletap_face_0:
          name: "Double Tap (Face 0 Up)"
          description: "Face 0 up."
          default: []
          selector:
            action: {}
        flipped90_face_0:
          name: "Flip 90° to Face 0"
          description: "Action ends with Face 0 up."
          default: []
          selector:
            action: {}
        flipped180_face_0:
          name: "Flip 180° to Face 0"
          description: "Face 0 up. Difficult to master."
          default: []
          selector:
            action: {}
        flip_from_any_to_face_0:
          name: "Flip from any to Face 0"
          description: "Ends with Face 0 up."
          default: []
          selector:
            action: {}
        rotate_cw_face_0:
          name: "Rotate Clockwise (Face 0 Up)"
          description: "Face 0 up."
          default: []
          selector:
            action: {}
        rotate_ccw_face_0:
          name: "Rotate Counter-Clockwise (Face 0 Up)"
          description: "Face 0 up."
          default: []
          selector:
            action: {}
    side_1_group_1_actions:
      name: "Face 1 Group 1 Actions"
      description: "Actions for Face 1 up."
      input:
        slide_face_1:
          name: "Slide (Face 1 Up)"
          default: []
          selector:
            action: {}
        doubletap_face_1:
          name: "Double Tap (Face 1 Up)"
          default: []
          selector:
            action: {}
        flipped90_face_1:
          name: "Flip 90° to Face 1"
          default: []
          selector:
            action: {}
        flipped180_face_1:
          name: "Flip 180° to Face 1"
          description: "Face 1 up. Difficult to master."
          default: []
          selector:
            action: {}
        flip_from_any_to_face_1:
          name: "Flip from any to Face 1"
          default: []
          selector:
            action: {}
        rotate_cw_face_1:
          name: "Rotate Clockwise (Face 1 Up)"
          default: []
          selector:
            action: {}
        rotate_ccw_face_1:
          name: "Rotate Counter-Clockwise (Face 1 Up)"
          default: []
          selector:
            action: {}
    side_2_group_1_actions:
      name: "Face 2 Group 1 Actions"
      description: "Actions for Face 2 up."
      input:
        slide_face_2:
          name: "Slide (Face 2 Up)"
          default: []
          selector:
            action: {}
        doubletap_face_2:
          name: "Double Tap (Face 2 Up)"
          default: []
          selector:
            action: {}
        flipped90_face_2:
          name: "Flip 90° to Face 2"
          default: []
          selector:
            action: {}
        flipped180_face_2:
          name: "Flip 180° to Face 2"
          description: "Face 2 up. Difficult to master."
          default: []
          selector:
            action: {}
        flip_from_any_to_face_2:
          name: "Flip from any to Face 2"
          default: []
          selector:
            action: {}
        rotate_cw_face_2:
          name: "Rotate Clockwise (Face 2 Up)"
          default: []
          selector:
            action: {}
        rotate_ccw_face_2:
          name: "Rotate Counter-Clockwise (Face 2 Up)"
          default: []
          selector:
            action: {}
    side_3_group_1_actions:
      name: "Face 3 Group 1 Actions"
      description: "Actions for Face 3 up."
      input:
        slide_face_3:
          name: "Slide (Face 3 Up)"
          default: []
          selector:
            action: {}
        doubletap_face_3:
          name: "Double Tap (Face 3 Up)"
          default: []
          selector:
            action: {}
        flipped90_face_3:
          name: "Flip 90° to Face 3"
          default: []
          selector:
            action: {}
        flipped180_face_3:
          name: "Flip 180° to Face 3"
          description: "Face 3 up. Difficult to master."
          default: []
          selector:
            action: {}
        flip_from_any_to_face_3:
          name: "Flip from any to Face 3"
          default: []
          selector:
            action: {}
        rotate_cw_face_3:
          name: "Rotate Clockwise (Face 3 Up)"
          default: []
          selector:
            action: {}
        rotate_ccw_face_3:
          name: "Rotate Counter-Clockwise (Face 3 Up)"
          default: []
          selector:
            action: {}
    side_4_group_1_actions:
      name: "Face 4 Group 1 Actions"
      description: "Actions for Face 4 up."
      input:
        slide_face_4:
          name: "Slide (Face 4 Up)"
          default: []
          selector:
            action: {}
        doubletap_face_4:
          name: "Double Tap (Face 4 Up)"
          default: []
          selector:
            action: {}
        flipped90_face_4:
          name: "Flip 90° to Face 4"
          default: []
          selector:
            action: {}
        flipped180_face_4:
          name: "Flip 180° to Face 4"
          description: "Face 4 up. Difficult to master."
          default: []
          selector:
            action: {}
        flip_from_any_to_face_4:
          name: "Flip from any to Face 4"
          default: []
          selector:
            action: {}
        rotate_cw_face_4:
          name: "Rotate Clockwise (Face 4 Up)"
          default: []
          selector:
            action: {}
        rotate_ccw_face_4:
          name: "Rotate Counter-Clockwise (Face 4 Up)"
          default: []
          selector:
            action: {}
    side_5_group_1_actions:
      name: "Face 5 Group 1 Actions"
      description: "Actions for Face 5 up."
      input:
        slide_face_5:
          name: "Slide (Face 5 Up)"
          default: []
          selector:
            action: {}
        doubletap_face_5:
          name: "Double Tap (Face 5 Up)"
          default: []
          selector:
            action: {}
        flipped90_face_5:
          name: "Flip 90° to Face 5"
          default: []
          selector:
            action: {}
        flipped180_face_5:
          name: "Flip 180° to Face 5"
          description: "Face 5 up. Difficult to master."
          default: []
          selector:
            action: {}
        flip_from_any_to_face_5:
          name: "Flip from any to Face 5"
          default: []
          selector:
            action: {}
        rotate_cw_face_5:
          name: "Rotate Clockwise (Face 5 Up)"
          default: []
          selector:
            action: {}
        rotate_ccw_face_5:
          name: "Rotate Counter-Clockwise (Face 5 Up)"
          default: []
          selector:
            action: {}
    any_side_group_2_actions:
      name: "Any Side Group 2 Actions"
      description: "Actions for triggers on any cube face. Warning: These actions may trigger with Group 1/3 actions if assigned."
      input:
        slide_any:
          name: "Slide (Any Side)"
          description: "Triggers for any side. Avoid double assignment."
          default: []
          selector:
            action: {}
        doubletap_any:
          name: "Double Tap (Any Side)"
          description: "Triggers for any side. Avoid double assignment."
          default: []
          selector:
            action: {}
        flipped90_any:
          name: "Flip 90° (Any Side)"
          description: "Triggers for any side. Avoid double assignment."
          default: []
          selector:
            action: {}
        flipped180_any:
          name: "Flip 180° (Any Side)"
          description: "Triggers for any side. Avoid double assignment."
          default: []
          selector:
            action: {}
        rotate_cw_any:
          name: "Rotate Clockwise (Any Side)"
          description: "Triggers for any side. Avoid double assignment."
          default: []
          selector:
            action: {}
        rotate_ccw_any:
          name: "Rotate Counter-Clockwise (Any Side)"
          description: "Triggers for any side. Avoid double assignment."
          default: []
          selector:
            action: {}
    side_0_group_3_actions:
      name: "Face 0 Group 3 Actions"
      description: "Actions when cube flips to Face 0 from another face."
      input:
        0_from_1:
          name: "Flip to Face 0 from Face 1"
          default: []
          selector:
            action: {}
        0_from_2:
          name: "Flip to Face 0 from Face 2"
          default: []
          selector:
            action: {}
        0_from_3:
          name: "Flip to Face 0 from Face 3"
          default: []
          selector:
            action: {}
        0_from_4:
          name: "Flip to Face 0 from Face 4"
          default: []
          selector:
            action: {}
        0_from_5:
          name: "Flip to Face 0 from Face 5"
          default: []
          selector:
            action: {}
    side_1_group_3_actions:
      name: "Face 1 Group 3 Actions"
      description: "Actions when cube flips to Face 1 from another face."
      input:
        1_from_0:
          name: "Flip to Face 1 from Face 0"
          default: []
          selector:
            action: {}
        1_from_2:
          name: "Flip to Face 1 from Face 2"
          default: []
          selector:
            action: {}
        1_from_3:
          name: "Flip to Face 1 from Face 3"
          default: []
          selector:
            action: {}
        1_from_4:
          name: "Flip to Face 1 from Face 4"
          default: []
          selector:
            action: {}
        1_from_5:
          name: "Flip to Face 1 from Face 5"
          default: []
          selector:
            action: {}
    side_2_group_3_actions:
      name: "Face 2 Group 3 Actions"
      description: "Actions when cube flips to Face 2 from another face."
      input:
        2_from_0:
          name: "Flip to Face 2 from Face 0"
          default: []
          selector:
            action: {}
        2_from_1:
          name: "Flip to Face 2 from Face 1"
          default: []
          selector:
            action: {}
        2_from_3:
          name: "Flip to Face 2 from Face 3"
          default: []
          selector:
            action: {}
        2_from_4:
          name: "Flip to Face 2 from Face 4"
          default: []
          selector:
            action: {}
        2_from_5:
          name: "Flip to Face 2 from Face 5"
          default: []
          selector:
            action: {}
    side_3_group_3_actions:
      name: "Face 3 Group 3 Actions"
      description: "Actions when cube flips to Face 3 from another face."
      input:
        3_from_0:
          name: "Flip to Face 3 from Face 0"
          default: []
          selector:
            action: {}
        3_from_1:
          name: "Flip to Face 3 from Face 1"
          default: []
          selector:
            action: {}
        3_from_2:
          name: "Flip to Face 3 from Face 2"
          default: []
          selector:
            action: {}
        3_from_4:
          name: "Flip to Face 3 from Face 4"
          default: []
          selector:
            action: {}
        3_from_5:
          name: "Flip to Face 3 from Face 5"
          default: []
          selector:
            action: {}
    side_4_group_3_actions:
      name: "Face 4 Group 3 Actions"
      description: "Actions when cube flips to Face 4 from another face."
      input:
        4_from_0:
          name: "Flip to Face 4 from Face 0"
          default: []
          selector:
            action: {}
        4_from_1:
          name: "Flip to Face 4 from Face 1"
          default: []
          selector:
            action: {}
        4_from_2:
          name: "Flip to Face 4 from Face 2"
          default: []
          selector:
            action: {}
        4_from_3:
          name: "Flip to Face 4 from Face 3"
          default: []
          selector:
            action: {}
        4_from_5:
          name: "Flip to Face 4 from Face 5"
          default: []
          selector:
            action: {}
    side_5_group_3_actions:
      name: "Face 5 Group 3 Actions"
      description: "Actions when cube flips to Face 5 from another face."
      input:
        5_from_0:
          name: "Flip to Face 5 from Face 0"
          default: []
          selector:
            action: {}
        5_from_1:
          name: "Flip to Face 5 from Face 1"
          default: []
          selector:
            action: {}
        5_from_2:
          name: "Flip to Face 5 from Face 2"
          default: []
          selector:
            action: {}
        5_from_3:
          name: "Flip to Face 5 from Face 3"
          default: []
          selector:
            action: {}
        5_from_4:
          name: "Flip to Face 5 from Face 4"
          default: []
          selector:
            action: {}
    group_4_actions:
      name: "Group 4 actions"
      description: "Shake is supported; drop is not available on Cube T1 Pro."
      input:
        shake:
          name: "Shake the cube"
          description: 'Triggers only once. Combine with any group.'
          default: []
          selector:
            action: {}
        drop:
          name: "Drop the cube"
          description: 'Not available on Cube T1 Pro.'
          default: []
          selector:
            action: {}

trigger:
- platform: event
  event_type: zha_event
  event_data:
    device_id: !input cube

variables:
  cube: !input cube
  friendly_name: '{{ state_attr( device_entities( cube )[0], ''friendly_name'').split('' '')[0] }}'
  action_input: '{{ trigger.event.data.command }}'
  flip_degrees: '{{ trigger.event.data.args.flip_degrees | default(90) | int(90) }}'
  action: '{{ iif(action_input == ''flip'', iif(flip_degrees == 180, ''flip180'', ''flip90''), action_input ) | default("unknown") }}'
  angle: '{{ trigger.event.data.args.relative_degrees | default(0) | float(0) }}'
  current_side: '{{ (trigger.event.data.args.activated_face | default(1) | int(1)) - 1 }}'
  last_side_input: !input last_side_input
  last_side: '{{ states(last_side_input) | int(0) }}'
  side: '{{ iif((action != ''rotate_right'' and action != ''rotate_left''), current_side, last_side) }}'

condition:
- condition: template
  value_template: '{{ trigger.event.data.command in ("rotate_right", "rotate_left", "flip", "slide", "knock", "shake", "drop") }}'
- alias: User pick
  condition: !input additional_conditions

action:
- alias: Store the current_side as the last_side for the next trigger
  service: input_number.set_value
  target:
    entity_id: !input last_side_input
  data:
    value: '{{ side }}'
- alias: Fire Last Action event (for troubleshooting and screen display)
  event: zha_cube_last_action
  event_data:
    action: '{{ action }}'
    side: '{{ side }}'
    current_side: '{{ current_side }}'
    last_side: '{{ last_side }}'
    device_id: '{{ cube }}'
    friendly_name: '{{ friendly_name }}'
    flip_degrees: '{{ flip_degrees }}'
    angle: '{{ angle }}'
- alias: "Group 2 and Group 4 actions for ANY Side"
  choose:
  - conditions: '{{ action == "slide" }}'
    sequence: !input slide_any
  - conditions: '{{ action == "knock" }}'
    sequence: !input doubletap_any
  - conditions: '{{ action == "rotate_right" }}'
    sequence: !input rotate_cw_any
  - conditions: '{{ action == "rotate_left" }}'
    sequence: !input rotate_ccw_any
  - conditions: '{{ action == "shake" }}'
    sequence: !input shake
  - conditions: '{{ action == "drop" }}'
    sequence: !input drop
  - conditions: '{{ action == "flip90" }}'
    sequence:
    - parallel:
      - !input flipped90_any
      - choose:
        - conditions: '{{ side == 0 }}'
          sequence: !input flip_from_any_to_face_0
        - conditions: '{{ side == 1 }}'
          sequence: !input flip_from_any_to_face_1
        - conditions: '{{ side == 2 }}'
          sequence: !input flip_from_any_to_face_2
        - conditions: '{{ side == 3 }}'
          sequence: !input flip_from_any_to_face_3
        - conditions: '{{ side == 4 }}'
          sequence: !input flip_from_any_to_face_4
        - conditions: '{{ side == 5 }}'
          sequence: !input flip_from_any_to_face_5
  - conditions: '{{ action == "flip180" }}'
    sequence:
    - parallel:
      - !input flipped180_any
      - choose:
        - conditions: '{{ side == 0 }}'
          sequence: !input flip_from_any_to_face_0
        - conditions: '{{ side == 1 }}'
          sequence: !input flip_from_any_to_face_1
        - conditions: '{{ side == 2 }}'
          sequence: !input flip_from_any_to_face_2
        - conditions: '{{ side == 3 }}'
          sequence: !input flip_from_any_to_face_3
        - conditions: '{{ side == 4 }}'
          sequence: !input flip_from_any_to_face_4
        - conditions: '{{ side == 5 }}'
          sequence: !input flip_from_any_to_face_5
- alias: "Group 1 actions by side"
  choose:
  - conditions: '{{ action == "slide" }}'
    sequence:
    - choose:
      - conditions: '{{ side == 0 }}'
        sequence: !input slide_face_0
      - conditions: '{{ side == 1 }}'
        sequence: !input slide_face_1
      - conditions: '{{ side == 2 }}'
        sequence: !input slide_face_2
      - conditions: '{{ side == 3 }}'
        sequence: !input slide_face_3
      - conditions: '{{ side == 4 }}'
        sequence: !input slide_face_4
      - conditions: '{{ side == 5 }}'
        sequence: !input slide_face_5
  - conditions: '{{ action == "knock" }}'
    sequence:
    - choose:
      - conditions: '{{ side == 0 }}'
        sequence: !input doubletap_face_0
      - conditions: '{{ side == 1 }}'
        sequence: !input doubletap_face_1
      - conditions: '{{ side == 2 }}'
        sequence: !input doubletap_face_2
      - conditions: '{{ side == 3 }}'
        sequence: !input doubletap_face_3
      - conditions: '{{ side == 4 }}'
        sequence: !input doubletap_face_4
      - conditions: '{{ side == 5 }}'
        sequence: !input doubletap_face_5
  - conditions: '{{ action == "flip90" }}'
    sequence:
    - choose:
      - conditions: '{{ side == 0 }}'
        sequence: !input flipped90_face_0
      - conditions: '{{ side == 1 }}'
        sequence: !input flipped90_face_1
      - conditions: '{{ side == 2 }}'
        sequence: !input flipped90_face_2
      - conditions: '{{ side == 3 }}'
        sequence: !input flipped90_face_3
      - conditions: '{{ side == 4 }}'
        sequence: !input flipped90_face_4
      - conditions: '{{ side == 5 }}'
        sequence: !input flipped90_face_5
  - conditions: '{{ action == "flip180" }}'
    sequence:
    - choose:
      - conditions: '{{ side == 0 }}'
        sequence: !input flipped180_face_0
      - conditions: '{{ side == 1 }}'
        sequence: !input flipped180_face_1
      - conditions: '{{ side == 2 }}'
        sequence: !input flipped180_face_2
      - conditions: '{{ side == 3 }}'
        sequence: !input flipped180_face_3
      - conditions: '{{ side == 4 }}'
        sequence: !input flipped180_face_4
      - conditions: '{{ side == 5 }}'
        sequence: !input flipped180_face_5
  - conditions: '{{ action == "rotate_right" }}'
    sequence:
    - choose:
      - conditions: '{{ side == 0 }}'
        sequence: !input rotate_cw_face_0
      - conditions: '{{ side == 1 }}'
        sequence: !input rotate_cw_face_1
      - conditions: '{{ side == 2 }}'
        sequence: !input rotate_cw_face_2
      - conditions: '{{ side == 3 }}'
        sequence: !input rotate_cw_face_3
      - conditions: '{{ side == 4 }}'
        sequence: !input rotate_cw_face_4
      - conditions: '{{ side == 5 }}'
        sequence: !input rotate_cw_face_5
  - conditions: '{{ action == "rotate_left" }}'
    sequence:
    - choose:
      - conditions: '{{ side == 0 }}'
        sequence: !input rotate_ccw_face_0
      - conditions: '{{ side == 1 }}'
        sequence: !input rotate_ccw_face_1
      - conditions: '{{ side == 2 }}'
        sequence: !input rotate_ccw_face_2
      - conditions: '{{ side == 3 }}'
        sequence: !input rotate_ccw_face_3
      - conditions: '{{ side == 4 }}'
        sequence: !input rotate_ccw_face_4
      - conditions: '{{ side == 5 }}'
        sequence: !input rotate_ccw_face_5
- alias: "Group 3 Side-to-side jump events"
  choose:
  - conditions: '{{ side == 0 }}'
    sequence:
    - choose:
      - conditions: '{{ last_side == 1 }}'
        sequence: !input 0_from_1
      - conditions: '{{ last_side == 2 }}'
        sequence: !input 0_from_2
      - conditions: '{{ last_side == 3 }}'
        sequence: !input 0_from_3
      - conditions: '{{ last_side == 4 }}'
        sequence: !input 0_from_4
      - conditions: '{{ last_side == 5 }}'
        sequence: !input 0_from_5
  - conditions: '{{ side == 1 }}'
    sequence:
    - choose:
      - conditions: '{{ last_side == 0 }}'
        sequence: !input 1_from_0
      - conditions: '{{ last_side == 2 }}'
        sequence: !input 1_from_2
      - conditions: '{{ last_side == 3 }}'
        sequence: !input 1_from_3
      - conditions: '{{ last_side == 4 }}'
        sequence: !input 1_from_4
      - conditions: '{{ last_side == 5 }}'
        sequence: !input 1_from_5
  - conditions: '{{ side == 2 }}'
    sequence:
    - choose:
      - conditions: '{{ last_side == 0 }}'
        sequence: !input 2_from_0
      - conditions: '{{ last_side == 1 }}'
        sequence: !input 2_from_1
      - conditions: '{{ last_side == 3 }}'
        sequence: !input 2_from_3
      - conditions: '{{ last_side == 4 }}'
        sequence: !input 2_from_4
      - conditions: '{{ last_side == 5 }}'
        sequence: !input 2_from_5
  - conditions: '{{ side == 3 }}'
    sequence:
    - choose:
      - conditions: '{{ last_side == 0 }}'
        sequence: !input 3_from_0
      - conditions: '{{ last_side == 1 }}'
        sequence: !input 3_from_1
      - conditions: '{{ last_side == 2 }}'
        sequence: !input 3_from_2
      - conditions: '{{ last_side == 4 }}'
        sequence: !input 3_from_4
      - conditions: '{{ last_side == 5 }}'
        sequence: !input 3_from_5
  - conditions: '{{ side == 4 }}'
    sequence:
    - choose:
      - conditions: '{{ last_side == 0 }}'
        sequence: !input 4_from_0
      - conditions: '{{ last_side == 1 }}'
        sequence: !input 4_from_1
      - conditions: '{{ last_side == 2 }}'
        sequence: !input 4_from_2
      - conditions: '{{ last_side == 3 }}'
        sequence: !input 4_from_3
      - conditions: '{{ last_side == 5 }}'
        sequence: !input 4_from_5
  - conditions: '{{ side == 5 }}'
    sequence:
    - choose:
      - conditions: '{{ last_side == 0 }}'
        sequence: !input 5_from_0
      - conditions: '{{ last_side == 1 }}'
        sequence: !input 5_from_1
      - conditions: '{{ last_side == 2 }}'
        sequence: !input 5_from_2
      - conditions: '{{ last_side == 3 }}'
        sequence: !input 5_from_3
      - conditions: '{{ last_side == 4 }}'
        sequence: !input 5_from_4
